name: backend-cicd

on:
  push:
    branches: 
    - main
    - feature/*
    - fix/*
    paths:
      - "backend/**"
  pull_request:
    branches: [main]
    paths:
      - "backend/**"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: check backend/src

  # test:
  #   name: Test
  #   runs-on: ubuntu-latest

  #   services:
  #     postgres:
  #       image: postgres:16-alpine
  #       env:
  #         POSTGRES_DB: pharmacies
  #         POSTGRES_USER: appuser
  #         POSTGRES_PASSWORD: apppassword
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 5s
  #         --health-timeout 3s
  #         --health-retries 5

  #   env:
  #     DATABASE_URL: postgresql://appuser:apppassword@localhost:5432/pharmacies

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up Python 3.12
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.12"
  #         cache: pip

  #     - name: Install dependencies
  #       working-directory: backend
  #       run: pip install -r requirements.txt

  #     - name: Run tests
  #       working-directory: backend
  #       run: pytest --tb=short

  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image_tag: ${{ steps.tag.outputs.value }}

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: echo "value=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:${{ steps.tag.outputs.value }}
            ${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:latest

  # deploy:
  #   name: Deploy to Kubernetes
  #   runs-on: ubuntu-latest
  #   needs: build-and-push

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up kubectl
  #       uses: azure/setup-kubectl@v4

  #     - name: Configure kubeconfig
  #       # Store your kubeconfig as a base64-encoded secret:
  #       # base64 -i ~/.kube/config | pbcopy  â†’  then paste into KUBECONFIG secret
  #       run: |
  #         mkdir -p ~/.kube
  #         echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

  #     - name: Update deployment image
  #       # Adjust 'backend' (deployment name) and 'api' (container name)
  #       # to match your k8s manifests
  #       run: |
  #         kubectl set image deployment/backend \
  #           api=${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:${{ needs.build-and-push.outputs.image_tag }}
  #         kubectl rollout status deployment/backend --timeout=120s
