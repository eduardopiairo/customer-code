name: backend-cicd

on:
  push:
    branches: 
    - main
    - feature/*
    - fix/*
    paths:
      - "backend/**"
      - ".github/workflows/backend-cicd.yml"
  pull_request:
    branches: 
    - main
    paths:
      - "backend/**"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: check backend/src

  test:
    name: Test
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: sqlite:///:memory:

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        working-directory: backend
        run: pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        working-directory: backend
        run: pytest --cov=src --cov-report=xml --tb=short

      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: backend/coverage.xml

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        working-directory: backend
        run: pip install bandit pip-audit -r requirements.txt

      - name: Run bandit
        run: bandit -r backend/src

      - name: Run pip-audit
        working-directory: backend
        run: pip-audit -r requirements.txt

  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: [lint, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image_tag: ${{ steps.tag.outputs.value }}

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: echo "value=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:${{ steps.tag.outputs.value }}
            ${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:latest

  # deploy:
  #   name: Deploy to Kubernetes
  #   runs-on: ubuntu-latest
  #   needs: build-and-push

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up kubectl
  #       uses: azure/setup-kubectl@v4

  #     - name: Configure kubeconfig
  #       # Store your kubeconfig as a base64-encoded secret:
  #       # base64 -i ~/.kube/config | pbcopy  â†’  then paste into KUBECONFIG secret
  #       run: |
  #         mkdir -p ~/.kube
  #         echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

  #     - name: Update deployment image
  #       # Adjust 'backend' (deployment name) and 'api' (container name)
  #       # to match your k8s manifests
  #       run: |
  #         kubectl set image deployment/backend \
  #           api=${{ secrets.DOCKERHUB_USERNAME }}/customer-code-api:${{ needs.build-and-push.outputs.image_tag }}
  #         kubectl rollout status deployment/backend --timeout=120s
